name: Mailer Microservices CI with ESO for secret mgmt
on:
  pull_request:
    branches: ['main','develop/*']
    types: [opened, synchronize, reopened]

# Both workflows should have the same concurrency group
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true  # Cancel any in-progress runs in the same group and runs only the latest commit

jobs:
  mailer-service-ci:
    uses: cloudhein/workflows/.github/workflows/common-jobs.yaml@69fd4d876565d31d6f210426bde68feedf36d0d5
    with:
      working-directory: 'cmd/mailer'
      go-version: ">=1.22"
      binary-name: 'mailer' # This maps to -o mailer
      sonar-project-key: cloudhein_mailer
      sonar-organization: cloudhein
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  mailer-deploy-service:
    if: github.ref == 'refs/heads/main' || (github.event_name == 'pull_request' && github.base_ref == 'main')
    needs: mailer-service-ci
    uses: cloudhein/workflows/.github/workflows/deploy-jobs.yaml@00f912660609215e6e3d33762d8e951cc80b93ba
    with:
      service-name: 'mailer'
      dockerhub-username: ${{ vars.DOCKERHUB_USERNAME }}
      manifest-file: 'mailer.yaml'
    secrets:
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      PERSONAL_ACCESS_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
